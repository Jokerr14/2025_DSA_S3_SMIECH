CREATE DATABASE ProjectManagementDB;
GO

USE ProjectManagementDB;
GO

CREATE TABLE Roles (
    Id INT PRIMARY KEY,
    RoleName NVARCHAR(100) NOT NULL UNIQUE
);
GO

CREATE TABLE Users (
    Id INT PRIMARY KEY IDENTITY(1,1),
    Username NVARCHAR(100) NOT NULL UNIQUE,
    Email NVARCHAR(150) NOT NULL UNIQUE,
    PasswordHash NVARCHAR(255) NOT NULL,
    RoleId INT NOT NULL,
    Salt NVARCHAR(150) NOT NULL,
    EmploymentStatus NVARCHAR(50) NOT NULL,
    CONSTRAINT FK_Users_Roles FOREIGN KEY (RoleId) REFERENCES Roles(Id)
    ON DELETE NO ACTION
);
GO

CREATE TABLE Teams (
    Id INT PRIMARY KEY IDENTITY(1,1),
    TeamName NVARCHAR(100) NOT NULL UNIQUE,
    Description NVARCHAR(255)
);
GO

CREATE TABLE TeamMembers (
    TeamId INT,
    UserId INT,
    PRIMARY KEY (TeamId, UserId),
    CONSTRAINT FK_TeamMembers_Teams FOREIGN KEY (TeamId) REFERENCES Teams(Id) ON DELETE CASCADE,
    CONSTRAINT FK_TeamMembers_Users FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE
);
GO

CREATE TABLE Projects (
    Id INT PRIMARY KEY IDENTITY(1,1),
    ProjectName NVARCHAR(150) NOT NULL,
    Description NVARCHAR(500),
    StartDate DATE,
    EndDate DATE
);
GO

CREATE TABLE TeamProjects (
    TeamId INT,
    ProjectId INT,
    PRIMARY KEY (TeamId, ProjectId),
    CONSTRAINT FK_TeamProjects_Teams FOREIGN KEY (TeamId) REFERENCES Teams(Id) ON DELETE CASCADE,
    CONSTRAINT FK_TeamProjects_Projects FOREIGN KEY (ProjectId) REFERENCES Projects(Id) ON DELETE CASCADE
);
GO

CREATE TABLE Tasks (
    Id INT PRIMARY KEY IDENTITY(1,1),
    Title NVARCHAR(150) NOT NULL,
    Description NVARCHAR(500),
    Status NVARCHAR(50) NOT NULL,
    DueDate DATE,
    ProjectId INT NOT NULL,
    CONSTRAINT FK_Tasks_Projects FOREIGN KEY (ProjectId) REFERENCES Projects(Id) ON DELETE CASCADE
);
GO

CREATE TABLE TaskAssignments (
    TaskId INT,
    UserId INT,
    TimeSpentHours DECIMAL(5, 2) NULL,
    PRIMARY KEY (TaskId, UserId),
    CONSTRAINT FK_TaskAssignments_Tasks FOREIGN KEY (TaskId) REFERENCES Tasks(Id) ON DELETE CASCADE,
    CONSTRAINT FK_TaskAssignments_Users FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE
);
GO

CREATE TABLE UserHistory (
    Id INT PRIMARY KEY IDENTITY(1,1),
    UserId INT NOT NULL,
    EventType NVARCHAR(50) NOT NULL,
    EventDate DATE NOT NULL,
    Notes NVARCHAR(500),
    CONSTRAINT FK_UserHistory_Users FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE
);
GO